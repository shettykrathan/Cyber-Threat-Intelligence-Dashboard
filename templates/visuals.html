<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Threat Visualizations | CTI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    @media (max-width: 768px) {
      .chart-container {
        height: 250px;
      }
    }
  </style>
</head>
<body class="min-h-screen p-4 md:p-6">
  <div id="loader" class="loading-screen">
    <div class="text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <div class="text-cyan-300 text-xl font-semibold">â³ Loading Visuals...</div>
    </div>
  </div>

  <div id="main-content" class="hidden">
    <!-- Header -->
    <header class="panel mb-6 fade-in">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-gradient mb-2">ğŸ“ˆ Threat Visualizations</h1>
          <p class="text-sm text-gray-400">
            {% if threats|length > 0 %}
              Visualizing data for: <span class="text-cyan-300 font-mono font-semibold">{{ threats[-1].ip }}</span>
            {% else %}
              No data available
            {% endif %}
          </p>
        </div>
        <nav class="flex flex-wrap gap-2">
          <a href="/" class="nav-link">ğŸ  Home</a>
          <a href="/history" class="nav-link">ğŸ“Š History</a>
          <a href="/export" class="nav-link">ğŸ“¥ Export CSV</a>
        </nav>
      </div>
    </header>

    {% if threats|length > 0 %}
      {% set entry = threats[-1] %}
      
      <!-- Charts Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- VirusTotal Chart -->
        <div class="panel slide-in" style="animation-delay: 0.1s">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">ğŸ›¡ï¸</span>
            <h2 class="text-xl text-cyan-300 font-semibold">VirusTotal Analysis</h2>
          </div>
          <p class="text-sm text-gray-400 mb-4">IP: <span class="text-cyan-300 font-mono">{{ entry.ip }}</span></p>
          <div class="chart-container">
            <canvas id="vtChart"></canvas>
          </div>
        </div>

        <!-- GreyNoise Chart -->
        <div class="panel slide-in" style="animation-delay: 0.2s">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">ğŸ”</span>
            <h2 class="text-xl text-cyan-300 font-semibold">GreyNoise Threat Score</h2>
          </div>
          <p class="text-sm text-gray-400 mb-4">IP: <span class="text-cyan-300 font-mono">{{ entry.ip }}</span></p>
          <div class="chart-container">
            <canvas id="gnChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Statistics Summary -->
      <div class="panel slide-in mb-6" style="animation-delay: 0.3s">
        <h3 class="text-xl text-cyan-300 font-semibold mb-4 text-center">ğŸ“Š Quick Statistics</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center p-4 bg-cyan-500/10 border border-cyan-500/30 rounded-lg">
            <p class="text-2xl font-bold text-cyan-300">
              {{ entry.virustotal.last_analysis_stats.harmless if entry.virustotal and entry.virustotal.last_analysis_stats else 0 }}
            </p>
            <p class="text-xs text-gray-400 mt-1">Harmless</p>
          </div>
          <div class="text-center p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
            <p class="text-2xl font-bold text-yellow-400">
              {{ entry.virustotal.last_analysis_stats.suspicious if entry.virustotal and entry.virustotal.last_analysis_stats else 0 }}
            </p>
            <p class="text-xs text-gray-400 mt-1">Suspicious</p>
          </div>
          <div class="text-center p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
            <p class="text-2xl font-bold text-red-400">
              {{ entry.virustotal.last_analysis_stats.malicious if entry.virustotal and entry.virustotal.last_analysis_stats else 0 }}
            </p>
            <p class="text-xs text-gray-400 mt-1">Malicious</p>
          </div>
          <div class="text-center p-4 bg-cyan-500/10 border border-cyan-500/30 rounded-lg">
            <p class="text-2xl font-bold text-cyan-300">
              {{ entry.greynoise.score if entry.greynoise and 'score' in entry.greynoise else 0 }}/100
            </p>
            <p class="text-xs text-gray-400 mt-1">GreyNoise Score</p>
          </div>
        </div>
      </div>
    {% else %}
      <div class="panel text-center py-12 fade-in">
        <div class="text-6xl mb-4">ğŸ“Š</div>
        <h3 class="text-xl text-cyan-300 font-semibold mb-2">No Data Available</h3>
        <p class="text-gray-400 mb-6">Perform an IP scan to generate visualizations.</p>
        <a href="/" class="btn-primary inline-block">ğŸ” Start Scanning</a>
      </div>
    {% endif %}

    <!-- Footer -->
    <footer class="text-center text-xs text-slate-500 mt-8 fade-in">
      <p>Â© 2025 Krathan â€” Elevating Cybersecurity</p>
    </footer>
  </div>

  <!-- Chart Rendering Script -->
  {% if threats|length > 0 %}
    <script>
      const entry = {{ threats[-1] | tojson | safe }};
      const vt = entry.virustotal?.last_analysis_stats || {};
      const gn = entry.greynoise || {};

      // VirusTotal Bar Chart
      const vtCtx = document.getElementById('vtChart');
      if (vtCtx) {
        new Chart(vtCtx, {
          type: 'bar',
          data: {
            labels: ['Harmless', 'Suspicious', 'Malicious', 'Timeout', 'Undetected'],
            datasets: [{
              label: 'VirusTotal Analysis',
              data: [
                vt.harmless || 0,
                vt.suspicious || 0,
                vt.malicious || 0,
                vt.timeout || 0,
                vt.undetected || 0
              ],
              backgroundColor: [
                'rgba(34, 197, 94, 0.8)',
                'rgba(250, 204, 21, 0.8)',
                'rgba(239, 68, 68, 0.8)',
                'rgba(100, 116, 139, 0.8)',
                'rgba(14, 165, 233, 0.8)'
              ],
              borderColor: [
                'rgb(34, 197, 94)',
                'rgb(250, 204, 21)',
                'rgb(239, 68, 68)',
                'rgb(100, 116, 139)',
                'rgb(14, 165, 233)'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                titleColor: '#00f7ff',
                bodyColor: '#ffffff',
                borderColor: '#00f7ff',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: '#94a3b8'
                },
                grid: {
                  color: 'rgba(0, 247, 255, 0.1)'
                }
              },
              x: {
                ticks: {
                  color: '#94a3b8'
                },
                grid: {
                  color: 'rgba(0, 247, 255, 0.1)'
                }
              }
            }
          }
        });
      }

      // GreyNoise Doughnut Chart
      const gnCtx = document.getElementById('gnChart');
      if (gnCtx) {
        const gnScore = gn.score || 0;
        new Chart(gnCtx, {
          type: 'doughnut',
          data: {
            labels: ['Threat Score', 'Remaining'],
            datasets: [{
              label: 'GreyNoise Threat Score',
              data: [gnScore, 100 - gnScore],
              backgroundColor: [
                gnScore > 70 ? 'rgba(239, 68, 68, 0.8)' : 
                gnScore > 40 ? 'rgba(250, 204, 21, 0.8)' : 
                'rgba(34, 197, 94, 0.8)',
                'rgba(51, 65, 85, 0.8)'
              ],
              borderColor: [
                gnScore > 70 ? 'rgb(239, 68, 68)' : 
                gnScore > 40 ? 'rgb(250, 204, 21)' : 
                'rgb(34, 197, 94)',
                'rgb(51, 65, 85)'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  color: '#94a3b8',
                  padding: 15
                }
              },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                titleColor: '#00f7ff',
                bodyColor: '#ffffff',
                borderColor: '#00f7ff',
                borderWidth: 1,
                callbacks: {
                  label: function(context) {
                    return `${context.label}: ${context.parsed}%`;
                  }
                }
              }
            }
          }
        });
      }

      // Show content after charts are ready
      window.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => {
          document.getElementById("loader").classList.add("hidden");
          const content = document.getElementById("main-content");
          content.classList.remove("hidden");
          content.classList.add("fade-in");
        }, 1000);
      });
    </script>
  {% else %}
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => {
          document.getElementById("loader").classList.add("hidden");
          const content = document.getElementById("main-content");
          content.classList.remove("hidden");
          content.classList.add("fade-in");
        }, 800);
      });
    </script>
  {% endif %}
</body>
</html>
